syntax = "proto3";

package ticket;

import "google/api/annotations.proto";

// _____ TicketTypeService _ PATHS KHÁC NHAU ĐỂ TRÁNH CONFLICT _____
service TicketTypeService {
  rpc CreateTicketType(CreateTicketTypeRequest) returns (TicketType) {
    option (google.api.http) = {
      post: "/v1/ticket-types/create"
      body: "*"
    };
  }
  
  rpc UpdateTicketType(UpdateTicketTypeRequest) returns (TicketType) {
    option (google.api.http) = {
      put: '/v1/ticket-types/{ticket_type_id}'
      body: "*"
    };
  }
  
  rpc GetTicketType(GetTicketTypeRequest) returns (TicketType) {
    option (google.api.http) = {
      get: "/v1/ticket-types/{ticket_type_id}"
    };
  }

  rpc GetTicketTypeWithAvailability(GetTicketTypeWithAvailabilityRequest) returns (TicketType) {
    option (google.api.http) = {
      get: "/v1/ticket-types/{ticket_type_id}/availability"
    };
  }

  // ✅ NEW: Publish ticket type to blockchain
  rpc PublishTicketType(PublishTicketTypeRequest) returns (PublishTicketTypeResponse) {
    option (google.api.http) = {
      post: "/v1/ticket-types/{ticket_type_id}/publish"
      body: "*"
    };
  }

  // ✅ NEW: Get all ticket types for admin
  rpc ListAllTicketTypes(ListAllTicketTypesRequest) returns (ListTicketTypesResponse) {
    option (google.api.http) = {
      get: "/v1/ticket-types"
    };
  }
  
  rpc ListTicketTypesByEvent(ListTicketTypesByEventRequest) returns (ListTicketTypesResponse) {
    option (google.api.http) = {
      get: "/v1/ticket-types/by-event/{event_id}"
    };
  }
  
  rpc ListTicketTypesBySession(ListTicketTypesBySessionRequest) returns (ListTicketTypesResponse) {
    option (google.api.http) = {
      get: "/v1/ticket-types/by-session/{event_id}/{session_id}"
    };
  }
}

// _____ TicketService _____
service TicketService {
  rpc InitiatePurchase(InitiatePurchaseRequest) returns (InitiatePurchaseResponse) {
    option (google.api.http) = {
      post: "/v1/tickets/initiate-purchase"
      body: "*"
    };
  }

  rpc PrepareMetadata(PrepareMetadataRequest) returns (PrepareMetadataResponse) {
    option (google.api.http) = {
      post: "/v1/tickets/prepare-metadata"
      body: "*"
    };
  }

  rpc ConfirmPaymentAndRequestMint(ConfirmPaymentAndRequestMintRequest) returns (ConfirmPaymentAndRequestMintResponse) {
    option (google.api.http) = {
      post: "/v1/tickets/confirm-payment-mint"
      body: "*"
    };
  }

  rpc ListAllTickets(ListAllTicketsRequest) returns (ListTicketsResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/all"
    };
  }

  rpc GetTicket(GetTicketRequest) returns (Ticket) {
    option (google.api.http) = {
      get: "/v1/tickets/{ticket_id}"
    };
  }
  
  rpc ListTicketsByEvent(ListTicketsByEventRequest) returns (ListTicketsResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/by-event/{event_id}"
    };
  }
  
  rpc ListTicketsByOwner(ListTicketsByOwnerRequest) returns (ListTicketsResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/by-owner/{owner_address}"
    };
  }

  rpc GenerateQRCode (GenerateQRCodeRequest) returns (GenerateQRCodeResponse) {
    option (google.api.http) = {
      post: "/v1/tickets/{ticket_id}/qr-code"
    };
  }
    
  rpc CheckIn (CheckInRequest) returns (CheckInResponse) {
    option (google.api.http) = {
      post: "/v1/tickets/check-in"
      body: "*"
    };
  }

  rpc GetEventDashboard(EventDashboardRequest) returns (EventDashboardResponse) {
    option (google.api.http) = {
      get: "/v1/events/{event_id}/analytics/dashboard"
    };
  }
  
  rpc GetOrganizerStats(OrganizerStatsRequest) returns (OrganizerStatsResponse) {
    option (google.api.http) = {
      get: "/v1/organizers/{organizer_id}/analytics"
    };
  }
  
  rpc GetCheckinAnalytics(CheckinAnalyticsRequest) returns (CheckinAnalyticsResponse) {
    option (google.api.http) = {
      get: "/v1/events/{event_id}/analytics/checkin"
    };
  }

  rpc GetSoldSeatsByEvent(GetSoldSeatsByEventRequest) returns (GetSoldSeatsByEventResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/sold-seats/event/{event_id}"
    };
  }

  rpc GetTicketMetadata(GetTicketMetadataRequest) returns (GetTicketMetadataResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/metadata/{ticket_id}"
    };
  }

  rpc GetMyTicketsWithDetails(GetMyTicketsWithDetailsRequest) returns (GetMyTicketsWithDetailsResponse) {
    option (google.api.http) = {
      get: "/v1/tickets/my-tickets/{owner_address}/details"
    };
  }

  // ✅ NEW: Admin Analytics
  rpc GetAdminAnalytics(GetAdminAnalyticsRequest) returns (GetAdminAnalyticsResponse) {
    option (google.api.http) = {
      get: "/v1/admin/analytics"
    };
  }

  // ✅ NEW: Organizer Analytics  
  rpc GetOrganizerAnalytics(GetOrganizerAnalyticsRequest) returns (GetOrganizerAnalyticsResponse) {
    option (google.api.http) = {
      get: "/v1/organizers/{organizer_id}/analytics"
    };
  }
}

message HourlyPurchase {
  int32 hour = 1;
  int32 initiated_count = 2;
  int32 confirmed_count = 3;
}

// message PurchaseFlowStep {
//   int32 hour = 1;
//   string status = 2;
//   int32 count = 3;
//   int32 total_quantity = 4;
// }

// _____ Models _____
message Ticket {
  string id = 1;
  string event_id = 2;
  string ticket_type_id = 3;
  string token_id = 4;
  string owner_address = 5;
  string session_id = 6;
  string status = 7;
  string token_uri_cid = 8;
  string transaction_hash = 9;
  int64 created_at = 10;
  string qr_code_data = 11;
  string check_in_status = 12;
  int64 check_in_time = 13;
  string check_in_location = 14;
  int64 expiry_time = 15;
  // ✅ THÊM: Seat information
  SeatInfo seat_info = 16;
}

// ✅ THÊM: Seat information message
message SeatInfo {
  string seat_key = 1;      // e.g., "section1-0-5"
  string section = 2;       // e.g., "section1"
  string row = 3;           // e.g., "0" (displayed as "A")
  string seat = 4;          // e.g., "5" (displayed as "6")
}

message TicketType {
  string id = 1;
  string event_id = 2;
  string session_id = 3;
  string contract_session_id = 4;
  string blockchain_event_id = 5;
  string blockchain_ticket_type_id = 6; // ✅ NEW: Blockchain ticket type ID
  string name = 7;
  int32 total_quantity = 8;
  int32 available_quantity = 9;
  string price_wei = 10;
  int64 created_at = 11;
  int64 updated_at = 12;
}

// _____ Request/Response Messages _____
message CreateTicketTypeRequest { 
  string event_id = 1; 
  string session_id = 2; 
  string name = 3; 
  int32 total_quantity = 4; 
  string price_wei = 5;
}

message UpdateTicketTypeRequest { 
  string ticket_type_id = 1; 
  string blockchain_event_id = 2;
  string blockchain_ticket_type_id = 3; // ✅ NEW: Optional blockchain ticket type ID
}

message GetTicketTypeRequest { 
  string ticket_type_id = 1; 
}

message GetTicketTypeWithAvailabilityRequest {
  string ticket_type_id = 1;
}

// ✅ NEW: Publish ticket type messages
message PublishTicketTypeRequest {
  string ticket_type_id = 1;
}

message PublishTicketTypeResponse {
  bool success = 1;
  string message = 2;
  TicketType ticket_type = 3;
  string blockchain_ticket_type_id = 4;
  string transaction_hash = 5;
}

message ListTicketTypesByEventRequest { 
  string event_id = 1; 
}

message ListTicketTypesBySessionRequest { 
  string event_id = 1; 
  string session_id = 2; 
}

message ListTicketTypesResponse { 
  repeated TicketType ticket_types = 1; 
}

// ✅ CẬP NHẬT: InitiatePurchaseRequest để hỗ trợ seat selection
message InitiatePurchaseRequest {
  string ticket_type_id = 1;
  string buyer_address = 2;
  int32 quantity = 3;                    // ✅ THÊM: Quantity cho non-seat events
  repeated string selected_seats = 4;    // ✅ THÊM: Selected seat keys cho seat events
}

message InitiatePurchaseResponse {
  string ticket_order_id = 1;
  string payment_contract_address = 2;
  string price_to_pay_wei = 3;
  string blockchain_event_id = 4;
  string blockchain_ticket_type_id = 5; // ✅ ADD
  string session_id_for_contract = 6;
  string token_uri_cid = 7; 
  string purchase_id = 8;
}

message ConfirmPaymentAndRequestMintRequest {
  string ticket_order_id = 1;
  string payment_transaction_hash = 2;
}

message ConfirmPaymentAndRequestMintResponse {
  Ticket ticket = 1;
  repeated Ticket tickets = 2;  // ✅ THÊM: Để hỗ trợ multiple tickets
}

message GetTicketRequest { 
  string ticket_id = 1; 
}

message ListTicketsByEventRequest { 
  string event_id = 1; 
  int32 page_size = 2; 
  string page_token = 3; 
}

message ListTicketsByOwnerRequest { 
  string owner_address = 1; 
  int32 page_size = 2; 
  string page_token = 3; 
}

message ListTicketsResponse { 
  repeated Ticket tickets = 1; 
  string next_page_token = 2; 
}

// Thêm messages cho check-in
message CheckInRequest {
  string qr_code_data = 1;
  string location = 2;
  string scanner_id = 3;
}

message CheckInResponse {
  bool success = 1;
  string message = 2;
  Ticket ticket = 3;
}

message GenerateQRCodeRequest {
  string ticket_id = 1;
}

message GenerateQRCodeResponse {
  bool success = 1;
  string message = 2;
  string qr_code_data = 3;
  string qr_code_image_base64 = 4;
}

message ListAllTicketsRequest {
  int32 page_size = 1;
  string page_token = 2;
  string status_filter = 3;
}

// ✅ Analytics messages (unchanged)
message EventDashboardRequest {
  string event_id = 1;
  DateRange date_range = 2;
}

message DateRange {
  int64 start_date = 1;
  int64 end_date = 2;
}


message TicketSummary {
  int32 total_tickets = 1;
  repeated StatusCount by_status = 2;
}

message StatusCount {
  string status = 1;
  int32 count = 2;
}

message RevenueSummary {
  string total_revenue_wei = 1;
  string platform_fees_wei = 2;
  string organizer_revenue_wei = 3;
  int32 transaction_count = 4;
}

message CheckinSummary {
  int32 total_minted = 1;
  repeated StatusCount by_status = 2;
}

message OrganizerStatsRequest {
  string organizer_id = 1;
}

message OrganizerStatsResponse {
  string organizer_id = 1;
  int32 total_events = 2;
  int32 total_tickets_sold = 3;
  string total_revenue_wei = 4;
  int32 active_events = 5;
}

message CheckinAnalyticsRequest {
  string event_id = 1;
  string time_period = 2;
}

message CheckinAnalyticsResponse {
  string event_id = 1;
  string time_period = 2;
  repeated HourlyCheckin hourly_checkins = 3;
  repeated LocationCount location_breakdown = 4;
  CheckinSummary summary = 5;
}

message HourlyCheckin {
  int32 hour = 1;
  int32 count = 2;
}

message LocationCount {
  string location = 1;
  int32 count = 2;
}

message PurchaseSummary {
  int32 total_purchases = 1;
  repeated StatusCount by_status = 2;
  string conversion_rate = 3;
  string abandonment_rate = 4;
}

message EventDashboardResponse {
  string event_id = 1;
  DateRange date_range = 2;
  TicketSummary ticket_summary = 3;
  PurchaseSummary purchase_summary = 4;
  RevenueSummary revenue_summary = 5;
  CheckinSummary checkin_summary = 6;
  repeated DailySale daily_trends = 7;
  repeated PurchaseFunnelStep purchase_funnel = 8;
  
  // ✅ ADD: Enhanced analytics fields
  repeated PurchaseFlowStep purchase_flow = 9;
  repeated RecentTransaction recent_transactions = 10;
  repeated RevenueByTicketType revenue_by_ticket_type = 11;
  repeated RevenueByHour revenue_by_hour = 12;
  repeated PaymentMethod payment_methods = 13;
  GasAnalysis gas_analysis = 14;
  repeated FailureReason failure_reasons = 15;
}

// ✅ ADD: New message types for enhanced analytics
message PurchaseFlowStep {
  string status = 1;
  int32 count = 2;
  int64 avg_completion_time_ms = 3;
}

message RecentTransaction {
  string id = 1;
  string type = 2;
  string status = 3;
  string created_at = 4;
  string description = 5;
  string amount_wei = 6;
  string transaction_hash = 7;
}

message RevenueByTicketType {
  string ticket_type_id = 1;
  string name = 2;
  string revenue_wei = 3;
  int32 tickets_sold = 4;
}

message RevenueByHour {
  int32 hour = 1;
  string revenue_wei = 2;
  int32 transaction_count = 3;
}

message PaymentMethod {
  string name = 1;
  string type = 2;
  int32 count = 3;
  string success_rate = 4;
}

message GasAnalysis {
  string avg_gas_used = 1;
  string avg_gas_price_gwei = 2;
  string total_gas_cost_eth = 3;
}

message FailureReason {
  string reason = 1;
  int32 count = 2;
}

message PurchaseFunnelStep {
  string status = 1;
  int32 count = 2;
  int64 avg_completion_time_ms = 3;
}

message DailySale {
  string date = 1;
  int32 tickets_sold = 2;
  int32 purchase_count = 3; // ✅ NEW: Purchase count per day
  string revenue_wei = 4; // ✅ NEW: Revenue per day
}

message GetSoldSeatsByEventRequest {
  string event_id = 1;
}

message SoldSeat {
  string seat_key = 1;
  string status = 2;
}

message GetSoldSeatsByEventResponse {
  string event_id = 1;
  repeated SoldSeat sold_seats = 2;
}

message GetTicketMetadataRequest {
  string ticket_id = 1;
}

message GetTicketMetadataResponse {
  string metadata = 1;
}

message PrepareMetadataRequest {
  string ticket_order_id = 1;
  int32 quantity = 2;
  repeated string selected_seats = 3;
}

message PrepareMetadataResponse {
  bool success = 1;
  repeated string metadata_uris = 2;
}

message ListAllTicketTypesRequest {
  int32 page_size = 1;
  string page_token = 2;
  string status_filter = 3;
  string organizer_id = 4;
  string event_id = 5;
}

// Thêm request message
message GetMyTicketsWithDetailsRequest {
  string owner_address = 1;  // Wallet address của người dùng
}

// Thêm response message
message GetMyTicketsWithDetailsResponse {
  repeated TicketWithDetails tickets = 1;
}

// Thêm TicketWithDetails message để chứa thông tin chi tiết
message TicketWithDetails {
  // Thông tin ticket
  string id = 1;
  string event_id = 2;
  string ticket_type_id = 3;
  string token_id = 4;
  string owner_address = 5;
  string session_id = 6;
  string status = 7;
  string token_uri_cid = 8;
  string transaction_hash = 9;
  int64 created_at = 10;
  string qr_code_data = 11;
  string check_in_status = 12;
  int64 check_in_time = 13;
  string check_in_location = 14;
  int64 expiry_time = 15;
  SeatInfo seat_info = 16;
  
  // Thông tin ticket type
  TicketTypeDetails ticket_type = 17;
  
  // Thông tin event
  EventDetails event = 18;
}

// Chi tiết ticket type
message TicketTypeDetails {
  string id = 1;
  string name = 2;
  string price_wei = 3;
}

// Chi tiết event
message EventDetails {
  string id = 1;
  string name = 2;
  string description = 3;
  string location = 4;
  string banner_url_cid = 5;
  repeated SessionDetails sessions = 6;
}

// Chi tiết session
message SessionDetails {
  string id = 1;
  string name = 2;
  int64 start_time = 3;
  int64 end_time = 4;
}

// ✅ NEW: Admin Analytics Messages
message GetAdminAnalyticsRequest {
  DateRange date_range = 1;
  string transaction_type = 2; // Optional filter: "TICKET_PURCHASE", "REVENUE_SETTLEMENT", etc.
}

message GetAdminAnalyticsResponse {
  DateRange date_range = 1;
  repeated TransactionSummary transaction_summary = 2;
  repeated DailyTrend daily_trends = 3;
  repeated TopEventByRevenue top_events_by_revenue = 4;
}

message TransactionSummary {
  string type = 1;
  int32 count = 2;
  string total_amount_wei = 3;
  string total_platform_fee_wei = 4;
  string total_organizer_amount_wei = 5;
}

message DailyTrend {
  string date = 1; // YYYY-MM-DD
  string type = 2;
  int32 count = 3;
  string total_amount_wei = 4;
}

message TopEventByRevenue {
  string event_id = 1;
  int32 tickets_sold = 2;
  string total_revenue_wei = 3;
  string organizer_revenue_wei = 4;
  string platform_fees_wei = 5;
}

// ✅ NEW: Organizer Analytics Messages
message GetOrganizerAnalyticsRequest {
  string organizer_id = 1;
  DateRange date_range = 2;
}

message GetOrganizerAnalyticsResponse {
  string organizer_id = 1;
  DateRange date_range = 2;
  repeated OrganizerTransactionSummary transaction_summary = 3;
  repeated OrganizerEventBreakdown event_breakdown = 4;
}

message OrganizerTransactionSummary {
  string type = 1;
  int32 count = 2;
  string total_revenue_wei = 3;
  int32 tickets_sold = 4;
}

message OrganizerEventBreakdown {
  string event_id = 1;
  int32 tickets_sold = 2;
  string total_revenue_wei = 3;
  string platform_fees_paid_wei = 4;
}

