_format_version: "3.0"
_comment: "Kong declarative configuration with consumer and JWT credential from ENV"

consumers:
  - username: generic-app-user # Tên consumer đại diện
    jwt_secrets: # <<< SỬ DỤNG TÊN TRƯỜNG NÀY
      - key: "my-application"      # Giá trị này phải khớp với 'iss' claim trong token của bạn
        algorithm: HS256           # Hoặc thuật toán bạn dùng (ví dụ: HS512)
        secret: "{env://KONG_JWT_SHARED_SECRET_VAR}" # Lấy secret từ biến môi trường

# --- Services (auth-grpc-service, user-grpc-service) ---
services:
  - name: auth-grpc-service
    # host: 172.23.0.3 
    host: auth-service.service.consul
    port: 50051 # Port của gRPC auth-service
    protocol: grpc
    plugins:
      - name: grpc-gateway
        config:
          proto: /etc/kong/protos/auth.proto

  - name: user-grpc-service
    # host: 172.23.0.4 
    host:  user-service.service.consul
    port: 50052 # Port của gRPC user-service (Lưu ý: port này khác với auth-service)
    protocol: grpc
    plugins:
      - name: grpc-gateway
        config:
          proto: /etc/kong/protos/user.proto

# --- Routes ---
routes:
  # Routes không cần xác thực (ví dụ: login, register)
  - name: auth-login-route-v1
    service: auth-grpc-service
    paths: ["/v1/auth/login"]
    methods: [POST]
    strip_path: true

  - name: auth-register-route-v1
    service: auth-grpc-service
    paths: ["/v1/auth/register"]
    methods: [POST]
    strip_path: true

  - name: auth-refresh-token-route-v1
    service: auth-grpc-service
    paths: ["/v1/auth/refresh-token"]
    methods: [POST]
    strip_path: true

  # Routes cần xác thực JWT (ví dụ: lấy thông tin user)
  - name: user-get-by-id-route-v1
    service: user-grpc-service
    paths: ["/v1/users/{user_id}"]
    methods: [GET]
    strip_path: true
    plugins:
      - name: jwt # Áp dụng plugin JWT
        config:
          key_claim_name: "iss"
          claims_to_verify: ["exp"]